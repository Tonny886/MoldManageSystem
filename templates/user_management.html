{% extends "base.html" %}

{% block title %}ç”¨æˆ·ç®¡ç† - å‚å®¶ä¿å…»äººå‘˜ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="header">
    <h1>ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ</h1>
    <p>ç®¡ç†ç³»ç»Ÿçš„ç”¨æˆ·è´¦æˆ·å’Œæƒé™</p>
</div>

<!-- æ·»åŠ ç”¨æˆ·è¡¨å• -->
<div class="card">
    <h3>â• æ·»åŠ æ–°ç”¨æˆ·</h3>
    <form id="addUserForm" class="user-form">
        <div class="form-row">
            <div class="form-group">
                <label for="username">ğŸ‘¤ ç”¨æˆ·åï¼š</label>
                <input type="text" id="username" name="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">ğŸ”’ å¯†ç ï¼š</label>
                <input type="password" id="password" name="password" required>
            </div>
            
            <div class="form-group">
                <label for="real_name">ğŸ‘¤ çœŸå®å§“åï¼š</label>
                <input type="text" id="real_name" name="real_name" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="role">ğŸ­ ç”¨æˆ·è§’è‰²ï¼š</label>
                <select id="role" name="role" required>
                    {% if user.role == 'super_admin' %}
                    <option value="super_admin">è¶…çº§ç®¡ç†å‘˜</option>
                    <option value="manufacturer_admin">å‚å®¶ç®¡ç†å‘˜</option>
                    {% endif %}
                    <option value="user" selected>æ™®é€šç”¨æˆ·</option>
                </select>
            </div>
            
            {% if user.role == 'super_admin' %}
            <div class="form-group">
                <label for="manufacturer_id">ğŸ­ æ‰€å±å‚å®¶ï¼š</label>
                <select id="manufacturer_id" name="manufacturer_id">
                    <option value="">æ— ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰</option>
                    {% for manufacturer in manufacturers %}
                    <option value="{{ manufacturer.manufacturer_id }}">{{ manufacturer.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="form-group">
                <label for="email">ğŸ“§ é‚®ç®±ï¼š</label>
                <input type="email" id="email" name="email">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="phone">ğŸ“ ç”µè¯ï¼š</label>
                <input type="tel" id="phone" name="phone">
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">âœ… æ·»åŠ ç”¨æˆ·</button>
            <button type="reset" class="btn btn-secondary">ğŸ”„ é‡ç½®</button>
        </div>
    </form>
</div>

<!-- ç”¨æˆ·åˆ—è¡¨ -->
<div class="card">
    <h3>ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨ ({{ users|length }} äºº)</h3>
    {% if users %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ç”¨æˆ·å</th>
                    <th>çœŸå®å§“å</th>
                    <th>è§’è‰²</th>
                    <th>æ‰€å±å‚å®¶</th>
                    <th>é‚®ç®±</th>
                    <th>ç”µè¯</th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {% for user_item in users %}
                <tr>
                    <td>{{ user_item.username }}</td>
                    <td>{{ user_item.real_name }}</td>
                    <td>
                        <span class="role-badge role-{{ user_item.role }}">
                            {{ user_roles[user_item.role] }}
                        </span>
                    </td>
                    <td>{{ user_item.manufacturer_id or 'æ— ' }}</td>
                    <td>{{ user_item.email or 'æœªå¡«å†™' }}</td>
                    <td>{{ user_item.phone or 'æœªå¡«å†™' }}</td>
                    <td>
                        {% if user_item.is_active %}
                        <span class="status-active">æ´»è·ƒ</span>
                        {% else %}
                        <span class="status-inactive">ç¦ç”¨</span>
                        {% endif %}
                    </td>
                    <td>{{ user_item.created_at[:16].replace('T', ' ') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>æš‚æ— ç”¨æˆ·è®°å½•</p>
    </div>
    {% endif %}
</div>

<div class="footer-actions">
    <a href="/" class="btn btn-secondary">ğŸ  è¿”å›é¦–é¡µ</a>
</div>

<script>
    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/add_user', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                this.reset();
                location.reload(); // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°ç”¨æˆ·
            } else {
                alert('æ·»åŠ å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            alert('æ·»åŠ å¤±è´¥: ' + error);
        });
    });

    // è§’è‰²é€‰æ‹©å˜åŒ–æ—¶å¤„ç†å‚å®¶é€‰æ‹©æ¡†
    document.getElementById('role').addEventListener('change', function() {
        const manufacturerSelect = document.getElementById('manufacturer_id');
        if (this.value === 'super_admin') {
            manufacturerSelect.value = '';
            manufacturerSelect.disabled = true;
        } else {
            manufacturerSelect.disabled = false;
        }
    });
</script>
{% endblock %}