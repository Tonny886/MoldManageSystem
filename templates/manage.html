{% extends "base.html" %}

{% block title %}ä¿å…»äººå‘˜ç®¡ç† - {{ manufacturer.name }}{% endblock %}

{% block content %}
<div class="header">
    <h1>{{ manufacturer.name }} - ä¿å…»äººå‘˜ç®¡ç†</h1>
    <div class="manufacturer-info">
        <p><strong>å‚å®¶ID:</strong> {{ manufacturer.manufacturer_id }} | 
           <strong>è”ç³»äºº:</strong> {{ manufacturer.contact_person }} | 
           <strong>ç”µè¯:</strong> {{ manufacturer.phone }} | 
           <strong>é‚®ç®±:</strong> {{ manufacturer.email }}</p>
    </div>
</div>

<!-- æˆåŠŸæ¶ˆæ¯æ˜¾ç¤º -->
{% if success %}
<div class="alert alert-success">
    âœ… {{ success }}
</div>
{% endif %}

<!-- é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º -->
{% if error %}
<div class="alert alert-error">
    âŒ {{ error }}
</div>
{% endif %}

<!-- å½“å‰ä¿å…»äººå‘˜åˆ—è¡¨ -->
<div class="card">
    <h2>ğŸ‘¥ å½“å‰ä¿å…»äººå‘˜ ({{ personnel|length }} äºº)</h2>
    {% if personnel %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>å·¥å·</th>
                    <th>å…¥èŒæ—¥æœŸ</th>
                    <th>å²—ä½</th>
                    <th>çŠ¶æ€</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ›´æ–°æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for person in personnel %}
                <tr>
                    <td>{{ person.personnel_name }}</td>
                    <td>{{ person.name_id or 'æœªå¡«å†™' }}</td>
                    <td>{{ person.hire_date or 'æœªå¡«å†™' }}</td>
                    <td>{{ person.position or 'æœªå¡«å†™' }}</td>
                    <td>
                        {% if person.is_active %}
                        <span class="status-active">æ´»è·ƒ</span>
                        {% else %}
                        <span class="status-inactive">å·²åˆ é™¤</span>
                        {% endif %}
                    </td>
                    <td>{{ person.note or 'æ— ' }}</td>
                    <td>{{ person.updated_at[:16].replace('T', ' ') if person.updated_at else 'æœªè®°å½•' }}</td>
                    <td class="actions">
                        <button class="btn btn-small btn-edit" 
                                data-id="{{ person.id }}"
                                data-name="{{ person.personnel_name }}"
                                data-name_id="{{ person.name_id or '' }}"
                                data-hire_date="{{ person.hire_date or '' }}"
                                data-position="{{ person.position or '' }}"
                                data-manufacturer_name="{{ person.manufacturer_name or '' }}"
                                data-note="{{ person.note or '' }}"
                                data-active="{{ person.is_active }}">
                            âœï¸ ç¼–è¾‘
                        </button>
                        {% if person.is_active %}
                        <form action="{{ url_for('delete_personnel') }}" method="POST" class="inline-form">
                            <input type="hidden" name="manufacturer_id" value="{{ manufacturer.manufacturer_id }}">
                            <input type="hidden" name="personnel_id" value="{{ person.id }}">
                            <button type="submit" class="btn btn-small btn-delete" data-name="{{ person.personnel_name }}">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </form>
                        {% else %}
                        <form action="{{ url_for('restore_personnel') }}" method="POST" class="inline-form">
                            <input type="hidden" name="manufacturer_id" value="{{ manufacturer.manufacturer_id }}">
                            <input type="hidden" name="personnel_id" value="{{ person.id }}">
                            <button type="submit" class="btn btn-small btn-restore" data-name="{{ person.personnel_name }}">
                                ğŸ”„ æ¢å¤
                            </button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>æš‚æ— ä¿å…»äººå‘˜è®°å½•</p>
    </div>
    {% endif %}
</div>

<!-- æ·»åŠ æ–°äººå‘˜ -->
<div class="card">
    <h2>â• æ·»åŠ æ–°ä¿å…»äººå‘˜</h2>
    <form action="{{ url_for('add_personnel') }}" method="POST" class="personnel-form" id="addPersonnelForm">
        <input type="hidden" name="manufacturer_id" value="{{ manufacturer.manufacturer_id }}">
        <input type="hidden" name="manufacturer_name" value="{{ manufacturer.name }}">
        
        <div class="form-row">
            <div class="form-group">
                <label for="personnel_name">ğŸ‘¤ å§“åï¼š</label>
                <input type="text" id="personnel_name" name="personnel_name" required 
                       placeholder="è¯·è¾“å…¥ä¿å…»äººå‘˜å§“å">
            </div>
            
            <div class="form-group">
                <label for="name_id">ğŸ†” å·¥å·ï¼š</label>
                <input type="text" id="name_id" name="name_id" 
                       placeholder="è¯·è¾“å…¥å‘˜å·¥å·¥å·">
            </div>
            
            <div class="form-group">
                <label for="hire_date">ğŸ“… å…¥èŒæ—¥æœŸï¼š</label>
                <input type="date" id="hire_date" name="hire_date" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="position">ğŸ’¼ å²—ä½ï¼š</label>
                <input type="text" id="position" name="position" 
                       placeholder="è¯·è¾“å…¥å²—ä½èŒè´£">
            </div>
            
            <div class="form-group full-width">
                <label for="note">ğŸ“ å¤‡æ³¨ä¿¡æ¯ï¼š</label>
                <textarea id="note" name="note" rows="3" 
                          placeholder="å¯åœ¨æ­¤å¡«å†™ä¿å…»äººå‘˜çš„å…¶ä»–ç›¸å…³ä¿¡æ¯"></textarea>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">âœ… æ·»åŠ äººå‘˜</button>
            <button type="reset" class="btn btn-secondary">ğŸ”„ æ¸…ç©ºè¡¨å•</button>
        </div>
    </form>
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>âœï¸ ç¼–è¾‘äººå‘˜ä¿¡æ¯</h3>
        <form action="{{ url_for('update_personnel') }}" method="POST" id="editForm">
            <input type="hidden" name="manufacturer_id" value="{{ manufacturer.manufacturer_id }}">
            <input type="hidden" name="personnel_id" id="editPersonnelId">
            <input type="hidden" name="is_active" id="editIsActive">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="editPersonnelName">ğŸ‘¤ å§“åï¼š</label>
                    <input type="text" id="editPersonnelName" name="personnel_name" required>
                </div>
                
                <div class="form-group">
                    <label for="editNameId">ğŸ†” å·¥å·ï¼š</label>
                    <input type="text" id="editNameId" name="name_id" required>
                </div>
                
                <div class="form-group">
                    <label for="editHireDate">ğŸ“… å…¥èŒæ—¥æœŸï¼š</label>
                    <input type="date" id="editHireDate" name="hire_date" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="editPosition">ğŸ’¼ å²—ä½ï¼š</label>
                    <input type="text" id="editPosition" name="position">
                </div>
                
                <div class="form-group">
                    <label for="editManufacturerName">ğŸ¢ å‚å®¶åç§°ï¼š</label>
                    <input type="text" id="editManufacturerName" name="manufacturer_name" value="{{ manufacturer.name }}" readonly>
                    <small class="form-help">è‡ªåŠ¨å¡«å……ï¼Œä¸å¯ç¼–è¾‘</small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="editNote">ğŸ“ å¤‡æ³¨ä¿¡æ¯ï¼š</label>
                <textarea id="editNote" name="note" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label>çŠ¶æ€ï¼š</label>
                <div class="status-display">
                    <span id="editStatusDisplay" class="status-active">â— æ´»è·ƒ</span>
                    <small class="form-help">çŠ¶æ€ä¸å¯ç›´æ¥ç¼–è¾‘ï¼Œè¯·ä½¿ç”¨åˆ é™¤/æ¢å¤åŠŸèƒ½</small>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">âŒ å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<div class="footer-actions">
    <a href="{{ url_for('query_manufacturer') }}" class="btn btn-secondary">â† è¿”å›æŸ¥è¯¢</a>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">ğŸ  è¿”å›é¦–é¡µ</a>
</div>

<script>
    // ä¸ºæ‰€æœ‰ç¼–è¾‘æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
        // ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const editButtons = document.querySelectorAll('.btn-edit');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                const name_id = this.getAttribute('data-name_id');
                const hire_date = this.getAttribute('data-hire_date');
                const position = this.getAttribute('data-position');
                const manufacturer_name = this.getAttribute('data-manufacturer_name');
                const note = this.getAttribute('data-note');
                const isActive = this.getAttribute('data-active') === 'True';
                
                openEditModal(id, name, name_id, hire_date, position, manufacturer_name, note, isActive);
            });
        });
        
        // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
        const deleteButtons = document.querySelectorAll('.btn-delete');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                const name = this.getAttribute('data-name');
                if (!confirm('ç¡®å®šè¦åˆ é™¤ ' + name + ' å—ï¼Ÿåˆ é™¤åå¯ä»¥æ¢å¤ã€‚')) {
                    e.preventDefault(); // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œé˜»æ­¢è¡¨å•æäº¤
                }
            });
        });
        
        // æ¢å¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const restoreButtons = document.querySelectorAll('.btn-restore');
        restoreButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                const name = this.getAttribute('data-name');
                if (!confirm('ç¡®å®šè¦æ¢å¤ ' + name + ' å—ï¼Ÿ')) {
                    e.preventDefault();
                }
            });
        });
        
        // æ·»åŠ è¡¨å•æäº¤æ—¶çš„ç®€å•éªŒè¯
        const addForm = document.getElementById('addPersonnelForm');
        if (addForm) {
            addForm.addEventListener('submit', function(e) {
                const nameInput = document.getElementById('personnel_name');
                const nameIdInput = document.getElementById('name_id');
                const hireDateInput = document.getElementById('hire_date');
                
                if (!nameInput.value.trim()) {
                    e.preventDefault();
                    alert('è¯·è¾“å…¥ä¿å…»äººå‘˜å§“å');
                    nameInput.focus();
                    return;
                }
                
                if (!nameIdInput.value.trim()) {
                    e.preventDefault();
                    alert('è¯·è¾“å…¥å‘˜å·¥å·¥å·');
                    nameIdInput.focus();
                    return;
                }
                
                if (!hireDateInput.value) {
                    e.preventDefault();
                    alert('è¯·é€‰æ‹©å…¥èŒæ—¥æœŸ');
                    hireDateInput.focus();
                    return;
                }
            });
        }
    });
    
    function openEditModal(id, name, name_id, hire_date, position, manufacturer_name, note, isActive) {
        document.getElementById('editPersonnelId').value = id;
        document.getElementById('editPersonnelName').value = name;
        document.getElementById('editNameId').value = name_id || '';
        document.getElementById('editHireDate').value = hire_date || '';
        document.getElementById('editPosition').value = position || '';
        document.getElementById('editManufacturerName').value = manufacturer_name || '';
        document.getElementById('editNote').value = note || '';
        document.getElementById('editIsActive').value = isActive;
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        const statusDisplay = document.getElementById('editStatusDisplay');
        if (isActive) {
            statusDisplay.textContent = 'â— æ´»è·ƒ';
            statusDisplay.className = 'status-active';
        } else {
            statusDisplay.textContent = 'â— å·²åˆ é™¤';
            statusDisplay.className = 'status-inactive';
        }
        
        document.getElementById('editModal').style.display = 'block';
    }
    
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            closeEditModal();
        }
    }
</script>
{% endblock %}